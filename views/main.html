

<div class="justify-content-center row">
<h1 class="display-2">MTM Box</h1><br>
</div>
<div class="justify-content-center row">
	<div class="col-sm-9 col-lg-9 ">
		<div class="card card-inverse card-info">
			<div class="card-header">Upload New File</div>
			<div class="card-block">
			<fieldset class="form-group">
	            <label>Chose a file</label>
	            <div class="input-group">
	            	<input type="file" value="upload" id="fileButton"/>
	            </div>
				<br>
	            <div class="progress">
					<div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" id="uploader"></div>
				</div> 
	      	</fieldset>
			</div>
		</div>
	</div>
</div>
<div class="justify-content-center row">
	<div class="col-sm-9 col-lg-9">
		<div class="card card-inverse card-primary">
			<div class="card-header">File Explorer</div>
			<div class="card-block">
				<ul id="list" class="fileExplorer list-unstyled"></ul>
			</div>
		</div>
	</div>
</div>
<style>
	.file{
		cursor: pointer; 
		cursor: hand;
	}
</style>
<!-- <img id="downloadFile" ></img> -->
<script>

	// List Elements
	// List Files
	var preObject = document.getElementById('object');
	var ulList = document.getElementById('list');

	var dbfile = firebase.database().ref().child('file');

	dbfile.on('child_added', snap => {
		var li = document.createElement('li');
		li.innerText = snap.val().name;
		console.log(snap.val());
		li.setAttribute("downloadUrl", snap.val().downloadUrl);
		li.setAttribute("size", snap.val().size);
		li.setAttribute("class", 'file');
		ulList.appendChild(li);
	});
	$('ul.fileExplorer').on('click','li.file', function(e){
		// Download Directly
		var xhr = new XMLHttpRequest();
		xhr.responseType = 'blob';
		xhr.onload = function(event) {
			var blob = xhr.response;
		};
		xhr.open('GET', 'https://firebasestorage.googleapis.com/v0/b/mtm-box.appspot.com/o/files%2F1619428_775340262495424_1615619256_n.jpg?alt=media&token=9b40a9e7-1139-4a54-8147-d759054afcf0');//$(this).downloadUrl);
		xhr.send();
	});

	/*
    // Download File
	storageRef.getDownloadURL().then(function(url) {

		// Download Directly
		var xhr = new XMLHttpRequest();
		xhr.responseType = 'blob';
		xhr.onload = function(event) {
			var blob = xhr.response;
		};
		xhr.open('GET', url);
		xhr.send();

		// Insert into Image
		var img = document.getElementById('downloadFile');
		img.src = url;

	}).catch(function(error) {
		switch (error.code) {
			case 'storage/object_not_found':
			// File doesn't exist
			break;

			case 'storage/unauthorized':
			// User doesn't have permission to access the object
			break;

			case 'storage/canceled':
			// User canceled the upload
			break;

			case 'storage/unknown':
			// Unknown error occurred, inspect the server response
			break;
		}
	});
	*/
    // Store new File

    // Get Elements
    var uploader = document.getElementById('uploader');
    var fileButton = document.getElementById('fileButton');

    fileButton.addEventListener('change', function(e){
        // Get elements
        var uploader = document.getElementById('uploader');
        var file = e.target.files[0];

        // Create Storage Ref
        var storageRef = firebase.storage().ref('storage/' + file.name);


        var task = storageRef.put(file);

        // Update progress bar
        task.on('state_changed', 

        	function progress(snapshot){
        		var percentage = (snapshot.bytesTransferred/snapshot.totalBytes) * 100;
        		uploader.setAttribute('style', style="width: "+percentage+"%");
        	},

        	function error(err){
        		alert('Upload Failed!');
        		uploader.setAttribute('style', style="width: 0%");
        		fileButton.value = '';
        	},

        	function complete(){
        		alert('Upload Completed!');
        		uploader.setAttribute('style', style="width: 0%");
        		fileButton.value = '';
        	}
        );
    });
</script>