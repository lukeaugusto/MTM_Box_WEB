

<div class="justify-content-center row">
<h1 class="display-2">MTM Box</h1><br>
</div>
<div class="justify-content-center row">
	<div class="col-sm-9 col-lg-9 ">
		<div class="card card-inverse card-info">
			<div class="card-header">Upload New File</div>
			<div class="card-block">
			<fieldset class="form-group">
	            <label>Chose a file</label>
	            <div class="input-group">
	            	<input type="file" value="upload" id="fileButton"/>
	            </div>
				<br>
	            <div class="progress">
					<div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" id="uploader"></div>
				</div> 
	      	</fieldset>
			</div>
		</div>
	</div>
</div>
<div class="justify-content-center row">
	<div class="col-sm-9 col-lg-9">
		<div class="card card-inverse card-primary">
			<div class="card-header">File Explorer</div>
			<div class="card-block">
				<ul id="list" class="fileExplorer list-unstyled"></ul>
			</div>
		</div>
	</div>
</div>
<style>
	.file{
		cursor: pointer; 
		cursor: hand;
	}
</style>
<!-- <img id="downloadFile" ></img> -->
<script>

	// List Files
	var ulList = document.getElementById('list');

	var dbfile = firebase.database().ref().child('file');

	dbfile.on('child_added', snap => {
		var li = document.createElement('li');
		li.innerText = snap.val().name;
		li.setAttribute("url", snap.val().url);
		li.setAttribute("size", snap.val().size);
		li.setAttribute("class", 'file');
		ulList.appendChild(li);
	});
	$('ul.fileExplorer').on('click','li.file', function(e){
		// Download Directly
		var xhr = new XMLHttpRequest();
		xhr.responseType = 'blob';
		xhr.onload = function(event) {
			var blob = xhr.response;
		};
		xhr.open('GET', $(this).url);
		xhr.send();
	});

    // Store new File
    // Get Elements
    var uploader = document.getElementById('uploader');
    var fileButton = document.getElementById('fileButton');

    fileButton.addEventListener('change', function(e){
        // Get elements
        var uploader = document.getElementById('uploader');
        var file = e.target.files[0];

        // Create Storage Ref
        var storageRef = firebase.storage().ref('file/' + file.name);


      	var task = storageRef.put(file);

        // Update progress bar
        task.on('state_changed', 

        	function progress(snapshot){
        		var percentage = (snapshot.bytesTransferred/snapshot.totalBytes) * 100;
        		uploader.setAttribute('style', style="width: "+percentage+"%");
        		if(snapshot.downloadURL !== null) {
					var ref = firebase.database().ref('file/' + file.name.substring(0, file.name.lastIndexOf('.')));
					ref.set({
						name: file.name,
						size: file.size,
						parent: 0,
						url: snapshot.downloadURL
					});
				}
        	},

        	function error(err){
        		alert('Upload Failed!');
        		uploader.setAttribute('style', style="width: 0%");
        		fileButton.value = '';
        	},

        	function complete(){
        		alert('Upload Completed!');
        		uploader.setAttribute('style', style="width: 0%");
        		fileButton.value = '';
        	}
        );
    });
</script>