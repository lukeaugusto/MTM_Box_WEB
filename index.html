<!--
 * GenesisUI - Bootstrap 4 Admin Template
 * @version v1.8.4
 * @link https://genesisui.com
 * Copyright (c) 2017 creativeLabs Łukasz Holeczek
 * @license Commercial
 -->
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Clever - Bootstrap 4 Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,AngularJS,Angular,Angular2,jQuery,CSS,HTML,RWD,Dashboard,Vue,Vue.js,React,React.js">
    <link rel="shortcut icon" href="img/favicon.png">

    <title>MTM BOX</title>

    <!-- Icons -->
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/simple-line-icons.css" rel="stylesheet">

    <!-- Main styles for this application -->
    <link href="css/style.css" rel="stylesheet">

</head>

<!-- BODY options, add following classes to body to change options

// Header options
1. '.header-fixed'					- Fixed Header

// Sidebar options
1. '.sidebar-fixed'					- Fixed Sidebar
2. '.sidebar-hidden'				- Hidden Sidebar
3. '.sidebar-off-canvas'		- Off Canvas Sidebar
4. '.sidebar-compact'				- Compact Sidebar Navigation (Only icons)

// Aside options
1. '.aside-menu-fixed'			- Fixed Aside Menu
2. '.aside-menu-hidden'			- Hidden Aside Menu
3. '.aside-menu-off-canvas'	- Off Canvas Aside Menu

// Footer options
1. 'footer-fixed'						- Fixed footer

-->

<body class="app header-hidden sidebar-hidden aside-menu-hidden aside-menu-hidden">


    <div class="justify-content-center row">
        <h1 class="display-6">MTM Box</h1><br>
    </div>
    <div class="justify-content-center row">
        <br><br>
        <div class="col-sm-9 col-lg-9 ">
            <div class="card card-inverse card-info">
                <div class="card-header">Upload New File</div>
                <div class="card-block">
                <fieldset class="form-group">
                    <label>Chose a file</label>
                    <div class="input-group">
                        <input type="file" value="upload" id="fileButton"/>
                    </div>
                    <br>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" id="uploader"></div>
                    </div> 
                </fieldset>
                </div>
            </div>
        </div>
    </div>
    <div class="justify-content-center row">
        <div class="col-sm-9 col-lg-9">
            <div class="card card-inverse card-primary">
                <div class="card-header">File Explorer</div>
                <div class="card-block">
                    <ul id="list" class="fileExplorer list-unstyled"></ul>
                </div>
            </div>
        </div>
    </div>
    <style>
        .file{
            cursor: pointer; 
            cursor: hand;
        }
    </style>
    <!-- <img id="downloadFile" ></img> -->
        

    <!-- Bootstrap and necessary plugins -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/tether/dist/js/tether.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/pace/pace.min.js"></script>


    <!-- Plugins and scripts required by all views -->
    <script src="bower_components/chart.js/dist/Chart.min.js"></script>


    <!-- GenesisUI main scripts -->

    <script src="js/app.js"></script>



    <!-- Plugins and scripts required by this views -->
    <script src="bower_components/toastr/toastr.min.js"></script>
    <script src="bower_components/gauge.js/dist/gauge.min.js"></script>
    <script src="bower_components/moment/min/moment.min.js"></script>
    <script src="bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>


    <!-- FireBase -->
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>

    <!-- Start Global Variables -->
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCo0cTqIqq8MgAtdVscPqTbZAakA2T9etM",
            authDomain: "mtm-box.firebaseapp.com",
            databaseURL: "https://mtm-box.firebaseio.com",
            projectId: "mtm-box",
            storageBucket: "mtm-box.appspot.com",
            messagingSenderId: "56184530107"
        };
        firebase.initializeApp(config);

        // List Files
        var ulList = document.getElementById('list');

        var dbfile = firebase.database().ref().child('file');

        dbfile.on('child_added', snap => {
            var li = document.createElement('li');
            li.innerText = snap.val().name;
            li.setAttribute("url", snap.val().url);
            li.setAttribute("size", snap.val().size);
            li.setAttribute("class", 'file');
            ulList.appendChild(li);
        });
        $('ul.fileExplorer').on('click','li.file', function(e){
            // Download Directly
            var xhr = new XMLHttpRequest();
            xhr.responseType = 'blob';
            xhr.onload = function(event) {
                var blob = xhr.response;
            };
            xhr.open('GET', $(this).url);
            xhr.send();
        });

        // Store new File
        // Get Elements
        var uploader = document.getElementById('uploader');
        var fileButton = document.getElementById('fileButton');

        fileButton.addEventListener('change', function(e){
            // Get elements
            var uploader = document.getElementById('uploader');
            var file = e.target.files[0];

            // Create Storage Ref
            var storageRef = firebase.storage().ref('file/' + file.name);


            var task = storageRef.put(file);

            // Update progress bar
            task.on('state_changed', 

                function progress(snapshot){
                    var percentage = (snapshot.bytesTransferred/snapshot.totalBytes) * 100;
                    uploader.setAttribute('style', style="width: "+percentage+"%");
                    if(snapshot.downloadURL !== null) {
                        var ref = firebase.database().ref('file/' + file.name.substring(0, file.name.lastIndexOf('.')));
                        ref.set({
                            name: file.name,
                            size: file.size,
                            parent: 0,
                            url: snapshot.downloadURL
                        });
                    }
                },

                function error(err){
                    alert('Upload Failed!');
                    uploader.setAttribute('style', style="width: 0%");
                    fileButton.value = '';
                },

                function complete(){
                    alert('Upload Completed!');
                    uploader.setAttribute('style', style="width: 0%");
                    fileButton.value = '';
                }
            );
        });
    </script>

</body>

</html>